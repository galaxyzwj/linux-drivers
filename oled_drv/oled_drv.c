#include <linux/kernel.h>
#include <linux/types.h>
#include <linux/cdev.h>
#include <linux/init.h>
#include <linux/module.h>
#include <linux/slab.h>
#include <linux/jiffies.h>
#include <linux/i2c.h>
#include <linux/mutex.h>
#include <linux/fs.h>
#include <asm/uaccess.h>
#include "oled12864.h"

#define OLED12864_CMD      0   //给oled发送 指令
#define OLED12864_DAT      1   //给oled发送 数据
#define OLED12864_WIDTH    128 //oled像素点 宽度
#define OLED12864_HEIGHT   64  //oled像素点 高度

#define OLED12864_NAME	"oled12864"

static uint8_t s_chDispalyBuffer[128][8]; // 将需要显示的数据建立为 二维数组

struct oled12864_dev {
	dev_t devid;				/* 设备号    */
	struct cdev cdev;			/* cdev     */
	struct class *class;		/* 类       */
	struct device *device;		/* 设备 	*/
	struct device_node	*nd; 	/* 设备节点  */
	int major;					/* 主设备号  */
	void *private_data;			/* 私有数据  */
} oled12864dev;

const uint8_t c_chFont1608[95][16] = {
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*" ",0*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0xCC,0x00,0x0C,0x00,0x00,0x00,0x00,0x00,0x00},/*"!",1*/
{0x00,0x00,0x08,0x00,0x30,0x00,0x60,0x00,0x08,0x00,0x30,0x00,0x60,0x00,0x00,0x00},/*""",2*/
{0x02,0x20,0x03,0xFC,0x1E,0x20,0x02,0x20,0x03,0xFC,0x1E,0x20,0x02,0x20,0x00,0x00},/*"#",3*/
{0x00,0x00,0x0E,0x18,0x11,0x04,0x3F,0xFF,0x10,0x84,0x0C,0x78,0x00,0x00,0x00,0x00},/*"$",4*/
{0x0F,0x00,0x10,0x84,0x0F,0x38,0x00,0xC0,0x07,0x78,0x18,0x84,0x00,0x78,0x00,0x00},/*"%",5*/
{0x00,0x78,0x0F,0x84,0x10,0xC4,0x11,0x24,0x0E,0x98,0x00,0xE4,0x00,0x84,0x00,0x08},/*"&",6*/
{0x08,0x00,0x68,0x00,0x70,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"'",7*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xE0,0x18,0x18,0x20,0x04,0x40,0x02,0x00,0x00},/*"(",8*/
{0x00,0x00,0x40,0x02,0x20,0x04,0x18,0x18,0x07,0xE0,0x00,0x00,0x00,0x00,0x00,0x00},/*")",9*/
{0x02,0x40,0x02,0x40,0x01,0x80,0x0F,0xF0,0x01,0x80,0x02,0x40,0x02,0x40,0x00,0x00},/*"*",10*/
{0x00,0x80,0x00,0x80,0x00,0x80,0x0F,0xF8,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x00},/*"+",11*/
{0x00,0x01,0x00,0x0D,0x00,0x0E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*",",12*/
{0x00,0x00,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80},/*"-",13*/
{0x00,0x00,0x00,0x0C,0x00,0x0C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*".",14*/
{0x00,0x00,0x00,0x06,0x00,0x18,0x00,0x60,0x01,0x80,0x06,0x00,0x18,0x00,0x20,0x00},/*"/",15*/
{0x00,0x00,0x07,0xF0,0x08,0x08,0x10,0x04,0x10,0x04,0x08,0x08,0x07,0xF0,0x00,0x00},/*"0",16*/
{0x00,0x00,0x08,0x04,0x08,0x04,0x1F,0xFC,0x00,0x04,0x00,0x04,0x00,0x00,0x00,0x00},/*"1",17*/
{0x00,0x00,0x0E,0x0C,0x10,0x14,0x10,0x24,0x10,0x44,0x11,0x84,0x0E,0x0C,0x00,0x00},/*"2",18*/
{0x00,0x00,0x0C,0x18,0x10,0x04,0x11,0x04,0x11,0x04,0x12,0x88,0x0C,0x70,0x00,0x00},/*"3",19*/
{0x00,0x00,0x00,0xE0,0x03,0x20,0x04,0x24,0x08,0x24,0x1F,0xFC,0x00,0x24,0x00,0x00},/*"4",20*/
{0x00,0x00,0x1F,0x98,0x10,0x84,0x11,0x04,0x11,0x04,0x10,0x88,0x10,0x70,0x00,0x00},/*"5",21*/
{0x00,0x00,0x07,0xF0,0x08,0x88,0x11,0x04,0x11,0x04,0x18,0x88,0x00,0x70,0x00,0x00},/*"6",22*/
{0x00,0x00,0x1C,0x00,0x10,0x00,0x10,0xFC,0x13,0x00,0x1C,0x00,0x10,0x00,0x00,0x00},/*"7",23*/
{0x00,0x00,0x0E,0x38,0x11,0x44,0x10,0x84,0x10,0x84,0x11,0x44,0x0E,0x38,0x00,0x00},/*"8",24*/
{0x00,0x00,0x07,0x00,0x08,0x8C,0x10,0x44,0x10,0x44,0x08,0x88,0x07,0xF0,0x00,0x00},/*"9",25*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x0C,0x03,0x0C,0x00,0x00,0x00,0x00,0x00,0x00},/*":",26*/
{0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*";",27*/
{0x00,0x00,0x00,0x80,0x01,0x40,0x02,0x20,0x04,0x10,0x08,0x08,0x10,0x04,0x00,0x00},/*"<",28*/
{0x02,0x20,0x02,0x20,0x02,0x20,0x02,0x20,0x02,0x20,0x02,0x20,0x02,0x20,0x00,0x00},/*"=",29*/
{0x00,0x00,0x10,0x04,0x08,0x08,0x04,0x10,0x02,0x20,0x01,0x40,0x00,0x80,0x00,0x00},/*">",30*/
{0x00,0x00,0x0E,0x00,0x12,0x00,0x10,0x0C,0x10,0x6C,0x10,0x80,0x0F,0x00,0x00,0x00},/*"?",31*/
{0x03,0xE0,0x0C,0x18,0x13,0xE4,0x14,0x24,0x17,0xC4,0x08,0x28,0x07,0xD0,0x00,0x00},/*"@",32*/
{0x00,0x04,0x00,0x3C,0x03,0xC4,0x1C,0x40,0x07,0x40,0x00,0xE4,0x00,0x1C,0x00,0x04},/*"A",33*/
{0x10,0x04,0x1F,0xFC,0x11,0x04,0x11,0x04,0x11,0x04,0x0E,0x88,0x00,0x70,0x00,0x00},/*"B",34*/
{0x03,0xE0,0x0C,0x18,0x10,0x04,0x10,0x04,0x10,0x04,0x10,0x08,0x1C,0x10,0x00,0x00},/*"C",35*/
{0x10,0x04,0x1F,0xFC,0x10,0x04,0x10,0x04,0x10,0x04,0x08,0x08,0x07,0xF0,0x00,0x00},/*"D",36*/
{0x10,0x04,0x1F,0xFC,0x11,0x04,0x11,0x04,0x17,0xC4,0x10,0x04,0x08,0x18,0x00,0x00},/*"E",37*/
{0x10,0x04,0x1F,0xFC,0x11,0x04,0x11,0x00,0x17,0xC0,0x10,0x00,0x08,0x00,0x00,0x00},/*"F",38*/
{0x03,0xE0,0x0C,0x18,0x10,0x04,0x10,0x04,0x10,0x44,0x1C,0x78,0x00,0x40,0x00,0x00},/*"G",39*/
{0x10,0x04,0x1F,0xFC,0x10,0x84,0x00,0x80,0x00,0x80,0x10,0x84,0x1F,0xFC,0x10,0x04},/*"H",40*/
{0x00,0x00,0x10,0x04,0x10,0x04,0x1F,0xFC,0x10,0x04,0x10,0x04,0x00,0x00,0x00,0x00},/*"I",41*/
{0x00,0x03,0x00,0x01,0x10,0x01,0x10,0x01,0x1F,0xFE,0x10,0x00,0x10,0x00,0x00,0x00},/*"J",42*/
{0x10,0x04,0x1F,0xFC,0x11,0x04,0x03,0x80,0x14,0x64,0x18,0x1C,0x10,0x04,0x00,0x00},/*"K",43*/
{0x10,0x04,0x1F,0xFC,0x10,0x04,0x00,0x04,0x00,0x04,0x00,0x04,0x00,0x0C,0x00,0x00},/*"L",44*/
{0x10,0x04,0x1F,0xFC,0x1F,0x00,0x00,0xFC,0x1F,0x00,0x1F,0xFC,0x10,0x04,0x00,0x00},/*"M",45*/
{0x10,0x04,0x1F,0xFC,0x0C,0x04,0x03,0x00,0x00,0xE0,0x10,0x18,0x1F,0xFC,0x10,0x00},/*"N",46*/
{0x07,0xF0,0x08,0x08,0x10,0x04,0x10,0x04,0x10,0x04,0x08,0x08,0x07,0xF0,0x00,0x00},/*"O",47*/
{0x10,0x04,0x1F,0xFC,0x10,0x84,0x10,0x80,0x10,0x80,0x10,0x80,0x0F,0x00,0x00,0x00},/*"P",48*/
{0x07,0xF0,0x08,0x18,0x10,0x24,0x10,0x24,0x10,0x1C,0x08,0x0A,0x07,0xF2,0x00,0x00},/*"Q",49*/
{0x10,0x04,0x1F,0xFC,0x11,0x04,0x11,0x00,0x11,0xC0,0x11,0x30,0x0E,0x0C,0x00,0x04},/*"R",50*/
{0x00,0x00,0x0E,0x1C,0x11,0x04,0x10,0x84,0x10,0x84,0x10,0x44,0x1C,0x38,0x00,0x00},/*"S",51*/
{0x18,0x00,0x10,0x00,0x10,0x04,0x1F,0xFC,0x10,0x04,0x10,0x00,0x18,0x00,0x00,0x00},/*"T",52*/
{0x10,0x00,0x1F,0xF8,0x10,0x04,0x00,0x04,0x00,0x04,0x10,0x04,0x1F,0xF8,0x10,0x00},/*"U",53*/
{0x10,0x00,0x1E,0x00,0x11,0xE0,0x00,0x1C,0x00,0x70,0x13,0x80,0x1C,0x00,0x10,0x00},/*"V",54*/
{0x1F,0xC0,0x10,0x3C,0x00,0xE0,0x1F,0x00,0x00,0xE0,0x10,0x3C,0x1F,0xC0,0x00,0x00},/*"W",55*/
{0x10,0x04,0x18,0x0C,0x16,0x34,0x01,0xC0,0x01,0xC0,0x16,0x34,0x18,0x0C,0x10,0x04},/*"X",56*/
{0x10,0x00,0x1C,0x00,0x13,0x04,0x00,0xFC,0x13,0x04,0x1C,0x00,0x10,0x00,0x00,0x00},/*"Y",57*/
{0x08,0x04,0x10,0x1C,0x10,0x64,0x10,0x84,0x13,0x04,0x1C,0x04,0x10,0x18,0x00,0x00},/*"Z",58*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0xFE,0x40,0x02,0x40,0x02,0x40,0x02,0x00,0x00},/*"[",59*/
{0x00,0x00,0x30,0x00,0x0C,0x00,0x03,0x80,0x00,0x60,0x00,0x1C,0x00,0x03,0x00,0x00},/*"\",60*/
{0x00,0x00,0x40,0x02,0x40,0x02,0x40,0x02,0x7F,0xFE,0x00,0x00,0x00,0x00,0x00,0x00},/*"]",61*/
{0x00,0x00,0x00,0x00,0x20,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x20,0x00,0x00,0x00},/*"^",62*/
{0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01},/*"_",63*/
{0x00,0x00,0x40,0x00,0x40,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"`",64*/
{0x00,0x00,0x00,0x98,0x01,0x24,0x01,0x44,0x01,0x44,0x01,0x44,0x00,0xFC,0x00,0x04},/*"a",65*/
{0x10,0x00,0x1F,0xFC,0x00,0x88,0x01,0x04,0x01,0x04,0x00,0x88,0x00,0x70,0x00,0x00},/*"b",66*/
{0x00,0x00,0x00,0x70,0x00,0x88,0x01,0x04,0x01,0x04,0x01,0x04,0x00,0x88,0x00,0x00},/*"c",67*/
{0x00,0x00,0x00,0x70,0x00,0x88,0x01,0x04,0x01,0x04,0x11,0x08,0x1F,0xFC,0x00,0x04},/*"d",68*/
{0x00,0x00,0x00,0xF8,0x01,0x44,0x01,0x44,0x01,0x44,0x01,0x44,0x00,0xC8,0x00,0x00},/*"e",69*/
{0x00,0x00,0x01,0x04,0x01,0x04,0x0F,0xFC,0x11,0x04,0x11,0x04,0x11,0x00,0x18,0x00},/*"f",70*/
{0x00,0x00,0x00,0xD6,0x01,0x29,0x01,0x29,0x01,0x29,0x01,0xC9,0x01,0x06,0x00,0x00},/*"g",71*/
{0x10,0x04,0x1F,0xFC,0x00,0x84,0x01,0x00,0x01,0x00,0x01,0x04,0x00,0xFC,0x00,0x04},/*"h",72*/
{0x00,0x00,0x01,0x04,0x19,0x04,0x19,0xFC,0x00,0x04,0x00,0x04,0x00,0x00,0x00,0x00},/*"i",73*/
{0x00,0x00,0x00,0x03,0x00,0x01,0x01,0x01,0x19,0x01,0x19,0xFE,0x00,0x00,0x00,0x00},/*"j",74*/
{0x10,0x04,0x1F,0xFC,0x00,0x24,0x00,0x40,0x01,0xB4,0x01,0x0C,0x01,0x04,0x00,0x00},/*"k",75*/
{0x00,0x00,0x10,0x04,0x10,0x04,0x1F,0xFC,0x00,0x04,0x00,0x04,0x00,0x00,0x00,0x00},/*"l",76*/
{0x01,0x04,0x01,0xFC,0x01,0x04,0x01,0x00,0x01,0xFC,0x01,0x04,0x01,0x00,0x00,0xFC},/*"m",77*/
{0x01,0x04,0x01,0xFC,0x00,0x84,0x01,0x00,0x01,0x00,0x01,0x04,0x00,0xFC,0x00,0x04},/*"n",78*/
{0x00,0x00,0x00,0xF8,0x01,0x04,0x01,0x04,0x01,0x04,0x01,0x04,0x00,0xF8,0x00,0x00},/*"o",79*/
{0x01,0x01,0x01,0xFF,0x00,0x85,0x01,0x04,0x01,0x04,0x00,0x88,0x00,0x70,0x00,0x00},/*"p",80*/
{0x00,0x00,0x00,0x70,0x00,0x88,0x01,0x04,0x01,0x04,0x01,0x05,0x01,0xFF,0x00,0x01},/*"q",81*/
{0x01,0x04,0x01,0x04,0x01,0xFC,0x00,0x84,0x01,0x04,0x01,0x00,0x01,0x80,0x00,0x00},/*"r",82*/
{0x00,0x00,0x00,0xCC,0x01,0x24,0x01,0x24,0x01,0x24,0x01,0x24,0x01,0x98,0x00,0x00},/*"s",83*/
{0x00,0x00,0x01,0x00,0x01,0x00,0x07,0xF8,0x01,0x04,0x01,0x04,0x00,0x00,0x00,0x00},/*"t",84*/
{0x01,0x00,0x01,0xF8,0x00,0x04,0x00,0x04,0x00,0x04,0x01,0x08,0x01,0xFC,0x00,0x04},/*"u",85*/
{0x01,0x00,0x01,0x80,0x01,0x70,0x00,0x0C,0x00,0x10,0x01,0x60,0x01,0x80,0x01,0x00},/*"v",86*/
{0x01,0xF0,0x01,0x0C,0x00,0x30,0x01,0xC0,0x00,0x30,0x01,0x0C,0x01,0xF0,0x01,0x00},/*"w",87*/
{0x00,0x00,0x01,0x04,0x01,0x8C,0x00,0x74,0x01,0x70,0x01,0x8C,0x01,0x04,0x00,0x00},/*"x",88*/
{0x01,0x01,0x01,0x81,0x01,0x71,0x00,0x0E,0x00,0x18,0x01,0x60,0x01,0x80,0x01,0x00},/*"y",89*/
{0x00,0x00,0x01,0x84,0x01,0x0C,0x01,0x34,0x01,0x44,0x01,0x84,0x01,0x0C,0x00,0x00},/*"z",90*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x3E,0xFC,0x40,0x02,0x40,0x02},/*"{",91*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00},/*"|",92*/
{0x00,0x00,0x40,0x02,0x40,0x02,0x3E,0xFC,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"}",93*/
{0x00,0x00,0x60,0x00,0x80,0x00,0x80,0x00,0x40,0x00,0x40,0x00,0x20,0x00,0x20,0x00},/*"~",94*/
};

struct i2c_client *oled_client;

static void oled12864_write_byte(uint8_t chData, uint8_t chCmd)
{
    uint8_t cmd = 0x00;
    if (chCmd) {
        cmd = 0x40; // 写入数据
    } else {
        cmd = 0x00; // 写入指令
    }
    i2c_smbus_write_byte_data(oled_client, cmd, chData);
}

//开启OLED显示
void oled12864_display_on(void)
{
    oled12864_write_byte(0x8D, OLED12864_CMD);//电荷泵使能
    oled12864_write_byte(0x14, OLED12864_CMD);//开启电荷泵
    oled12864_write_byte(0xAF, OLED12864_CMD);//点亮屏幕
}
//关闭OLED显示
void oled12864_display_off(void)
{
    oled12864_write_byte(0x8D, OLED12864_CMD);//电荷泵使能
    oled12864_write_byte(0x10, OLED12864_CMD);//关闭电荷泵
    oled12864_write_byte(0xAE, OLED12864_CMD);//关闭屏幕
}

void oled12864_refresh_gram(void)
{
    uint8_t i, j;
    for (i = 0; i < 8; i ++) {
        oled12864_write_byte(0xB0 + i, OLED12864_CMD);
        oled12864_write_byte(0x02, OLED12864_CMD);
        oled12864_write_byte(0x10, OLED12864_CMD);
        for (j = 0; j < 128; j ++) {
            oled12864_write_byte(s_chDispalyBuffer[j][i], OLED12864_DAT);
        }
    }
}

/*
 * @brief  清屏
 * @param  chFill: 0=>清屏 0xff=>点亮全屏幕
 * @retval None
 */
void oled12864_clear_screen(uint8_t chFill)
{
    memset(s_chDispalyBuffer,chFill, sizeof(s_chDispalyBuffer));
    oled12864_refresh_gram();
}

/*
 * @brief  画点
 * @param  chXpos : 起始点x
 * @param  chYpos : 起始点y
 * @param  chPoint: 0=>对该点清零 1=>填充该点即点亮该点
 * @retval None
 */
void oled12864_draw_point(uint8_t chXpos, uint8_t chYpos, uint8_t chPoint)
{
    uint8_t chPos, chBx, chTemp = 0;

    if (chXpos > 127 || chYpos > 63) {
        return;
    }
    chPos = 7 - chYpos / 8;
    chBx = chYpos % 8;
    chTemp = 1 << (7 - chBx);
    if (chPoint) {
        s_chDispalyBuffer[chXpos][chPos] |= chTemp;
    } else {
        s_chDispalyBuffer[chXpos][chPos] &= ~chTemp;
    }
}

/*
 * @brief  画矩形方块
 * @param  chXpos1: 矩形左上角x坐标
 * @param  chYpos1: 矩形左上角y坐标
 * @param  chXpos2: 矩形右下角x坐标
 * @param  chYpos3: 矩形右下角y坐标
 * @param  chDot:   0=>框内所有点清零 1=>框内所有点点亮
 * @retval None
 */
void oled12864_fill_screen(uint8_t chXpos1, uint8_t chYpos1, uint8_t chXpos2, uint8_t chYpos2, uint8_t chDot)
{
    uint8_t chXpos, chYpos;
    for (chXpos = chXpos1; chXpos <= chXpos2; chXpos ++) {
        for (chYpos = chYpos1; chYpos <= chYpos2; chYpos ++) {
            oled12864_draw_point(chXpos, chYpos, chDot);
        }
    }
    oled12864_refresh_gram();
}

/*
 * @brief  显示字符
 * @param  chXpos: 起始x坐标(起始点坐标指的是字符左上角起点)
 * @param  chYpos: 起始y坐标
 * @param  chSize: 选择字体大小 12/16
 * @param  chMode: 显示模式 0=>反白显示 1=>正常显示
 * @retval None
 */
void oled12864_display_char(uint8_t chXpos, uint8_t chYpos, uint8_t chChr, uint8_t chSize, uint8_t chMode)
{
    uint8_t i, j;
    uint8_t chTemp, chYpos0 = chYpos;

    chChr = chChr - ' ';
    for (i = 0; i < chSize; i ++) {
        if (chMode) {
            chTemp = c_chFont1608[chChr][i];
        } else {
            chTemp = ~c_chFont1608[chChr][i];
        }

        for (j = 0; j < 8; j ++) {
            if (chTemp & 0x80) {
                oled12864_draw_point(chXpos, chYpos, 1);
            } else {
                oled12864_draw_point(chXpos, chYpos, 0);
            }
            chTemp <<= 1;
            chYpos ++;

            if ((chYpos - chYpos0) == chSize) {
                chYpos = chYpos0;
                chXpos ++;
                break;
            }
        }
    }
}

/*
 * @brief  显示字符串
 * @param  chXpos   : 起始x坐标
 * @param  chYpos   : 起始y坐标
 * @param  pchString: 需要显示的字符串
 * @param  chSize   : 字体大小 12/16
 * @param  chMode   : 显示模式 0=>反白显示 1=>正常显示
 * @retval None
 */
void oled12864_display_string(uint8_t chXpos, uint8_t chYpos, const uint8_t *pchString, uint8_t chSize, uint8_t chMode)
{
    printk("%s, ssd1306 str = %s\n", __func__, pchString);
    while (*pchString != '\0') {
        if (chXpos > (OLED12864_WIDTH - chSize / 2)) {
            chXpos = 0;
            chYpos += chSize;
            if (chYpos > (OLED12864_HEIGHT - chSize)) {
                chYpos = chXpos = 0;
                oled12864_clear_screen(0x00);
            }
        }

        oled12864_display_char(chXpos, chYpos, *pchString, chSize, chMode);
        chXpos += chSize / 2;
        pchString ++;
    }
}

static int oled12864_open(struct inode *inode, struct file *filp)
{
	//filp->private_data = &oled12864dev; /* 设置私有数据 */
    printk("__%s__\r\n", __FUNCTION__);
    return 0;
}

static long int oled12864_ioctl(struct file *filp, unsigned int cmd, unsigned long arg)
{
    /* 检测命令的有效性 */
    if (_IOC_TYPE(cmd) != OLED_IOC_MAGIC) 
        return -EINVAL;

    switch (cmd) {
        case OLED_IOC_OPEN:
            oled12864_display_on();
            break;
        case OLED_IOC_CLOSE:
            oled12864_display_off();
            break;
        case OLED_IOC_REFRESH:
            oled12864_refresh_gram();
            break;
        case OLED_IOC_CLEAR:
             oled12864_clear_screen(); 
            break;

        case OLED_IOC_SET_CHAR:
            
            break;
        case OLED_IOC_SET_STRING:

            break;



        default:
            break;
    }

	return 0;
}

/* oled12864操作函数 */
static const struct file_operations oled12864_ops = {
	.owner = THIS_MODULE,
    .open = oled12864_open,
    // .read = oled12864_read,
    // .write = oled12864_write,
	.unlocked_ioctl = oled12864_ioctl,
};

void oled12864_init(void)
{
    oled12864_write_byte(0xAE, OLED12864_CMD);//--turn off oled panel
    oled12864_write_byte(0x00, OLED12864_CMD);//---set low column address
    oled12864_write_byte(0x10, OLED12864_CMD);//---set high column address
    oled12864_write_byte(0x40, OLED12864_CMD);//--set start line address  Set Mapping RAM Display Start Line (0x00~0x3F)
    oled12864_write_byte(0x81, OLED12864_CMD);//--set contrast control register
    oled12864_write_byte(0xCF, OLED12864_CMD);// Set SEG Output Current Brightness
    oled12864_write_byte(0xA1, OLED12864_CMD);//--Set SEG/Column Mapping
    oled12864_write_byte(0xC0, OLED12864_CMD);//Set COM/Row Scan Direction
    oled12864_write_byte(0xA6, OLED12864_CMD);//--set normal display
    oled12864_write_byte(0xA8, OLED12864_CMD);//--set multiplex ratio(1 to 64)
    oled12864_write_byte(0x3f, OLED12864_CMD);//--1/64 duty
    oled12864_write_byte(0xD3, OLED12864_CMD);//-set display offset    Shift Mapping RAM Counter (0x00~0x3F)
    oled12864_write_byte(0x00, OLED12864_CMD);//-not offset
    oled12864_write_byte(0xd5, OLED12864_CMD);//--set display clock divide ratio/oscillator frequency
    oled12864_write_byte(0x80, OLED12864_CMD);//--set divide ratio, Set Clock as 100 Frames/Sec
    oled12864_write_byte(0xD9, OLED12864_CMD);//--set pre-charge period
    oled12864_write_byte(0xF1, OLED12864_CMD);//Set Pre-Charge as 15 Clocks & Discharge as 1 Clock
    oled12864_write_byte(0xDA, OLED12864_CMD);//--set com pins hardware configuration
    oled12864_write_byte(0x12, OLED12864_CMD);
    oled12864_write_byte(0xDB, OLED12864_CMD);//--set vcomh
    oled12864_write_byte(0x40, OLED12864_CMD);//Set VCOM Deselect Level
    oled12864_write_byte(0x20, OLED12864_CMD);//-Set Page Addressing Mode (0x00/0x01/0x02)
    oled12864_write_byte(0x02, OLED12864_CMD);//
    oled12864_write_byte(0x8D, OLED12864_CMD);//--set Charge Pump enable/disable
    oled12864_write_byte(0x14, OLED12864_CMD);//--set(0x10) disable
    oled12864_write_byte(0xA4, OLED12864_CMD);// Disable Entire Display On (0xa4/0xa5)
    oled12864_write_byte(0xA6, OLED12864_CMD);// Disable Inverse Display On (0xa6/a7)
    oled12864_write_byte(0xAF, OLED12864_CMD);//--turn on oled panel

    // oled12864_display_on();
    // oled12864_clear_screen(0xff);
}

static int oled12864_probe(struct i2c_client *client, const struct i2c_device_id *id)
{
    printk("oled12864_probe\n");
    printk("%s, addr = %x, line = %d\n", __func__, client->addr, client->adapter->nr);
    printk("%s, name = %s, adapter nr = %d\n", __func__, client->adapter->name, client->adapter->nr);

    oled_client = client;

	/* 1、构建设备号 */
	if (oled12864dev.major) {
		oled12864dev.devid = MKDEV(oled12864dev.major, 0);
		register_chrdev_region(oled12864dev.devid, 1, OLED12864_NAME); // 
	} else {
		alloc_chrdev_region(&oled12864dev.devid, 0, 1, OLED12864_NAME); // 动态分配
		oled12864dev.major = MAJOR(oled12864dev.devid);
	}
	/* 2、注册设备 */
	cdev_init(&oled12864dev.cdev, &oled12864_ops);
	cdev_add(&oled12864dev.cdev, oled12864dev.devid, 1);
	/* 3、创建类 */
	oled12864dev.class = class_create(THIS_MODULE, OLED12864_NAME);
	if (IS_ERR(oled12864dev.class)) {
		return PTR_ERR(oled12864dev.class);
	}
	/* 4、创建设备 */
	oled12864dev.device = device_create(oled12864dev.class, NULL, oled12864dev.devid, NULL, OLED12864_NAME);
	if (IS_ERR(oled12864dev.device)) {
		return PTR_ERR(oled12864dev.device);
	}

	oled12864dev.private_data = client; /* 设置私有数据 */

    oled12864_init();
    oled12864_clear_screen(0x00);
    oled12864_display_on();
    oled12864_display_string(0, 0, "oled12864 is ok!", 16, 1);
    oled12864_display_string(0, 30, "oled12864 is ok!", 16, 0);
    oled12864_fill_screen(0,50,50,60,1);
    oled12864_display_char(60,50,'X',16,1);
    oled12864_refresh_gram();
    return 0;
};

static int oled12864_remove(struct i2c_client *client)
{
    printk("oled12864_remove ");
    oled12864_clear_screen(0x00);
    oled12864_display_off();

	/* 删除设备 */
	cdev_del(&oled12864dev.cdev);
	unregister_chrdev_region(oled12864dev.devid, 1);

	/* 注销掉类和设备 */
	device_destroy(oled12864dev.class, oled12864dev.devid);
	class_destroy(oled12864dev.class);
    return 0;
}

static const struct i2c_device_id oled12864_id[] = {
        { "oled12864", 0 },
        { }
};
MODULE_DEVICE_TABLE(i2c, oled12864_id);

static struct i2c_driver oled12864_driver = {
        .probe = oled12864_probe,
        .remove = oled12864_remove,
        .id_table = oled12864_id,
        .driver = {
                .name = "oled",
        },
};

module_i2c_driver(oled12864_driver);
MODULE_LICENSE("GPL");
